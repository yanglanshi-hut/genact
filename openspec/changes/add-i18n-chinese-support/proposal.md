# Change: 添加中文国际化支持

## Why

genact 作为一个在全球范围内使用的命令行工具,目前仅支持英文界面。对于中文用户来说,虽然模拟场景本身是通用的,但 CLI 帮助信息、错误消息和部分输出内容的中文化能够显著提升用户体验,降低使用门槛。

中国拥有庞大的开发者社区,添加中文支持可以:
- 扩大用户群体,让更多中文用户能够轻松使用 genact
- 提升项目的国际化程度,为后续支持更多语言打下基础
- 保持项目的趣味性和易用性,让中文用户也能享受"装忙"的乐趣

## What Changes

本提案引入完整的国际化(i18n)基础设施,初步支持简体中文:

### 核心变更
- **i18n 框架集成**: 选择并集成适合 Rust CLI 和 WASM 的国际化库
- **语言切换机制**: 实现运行时语言切换,支持 CLI 参数和环境变量
- **翻译资源管理**: 创建翻译文件结构,支持英文和简体中文
- **自动语言检测**: 根据系统区域设置自动选择界面语言

### 中文化范围(分阶段)
1. **Phase 1 - CLI 基础设施**:
   - CLI 帮助信息 (`--help` 输出)
   - 错误消息和警告
   - 命令行参数描述
   - 完成消息("Saving work to disk...")

2. **Phase 2 - 模块输出**(可选):
   - 模块通用状态词("Downloading", "Compiling", "Finished" 等)
   - 保持技术术语和包名等内容为英文(保真度考虑)

3. **Phase 3 - Web 支持**(可选):
   - Web 界面语言切换
   - 通过 URL 参数或浏览器语言检测

### 技术实现
- 新增 `src/i18n.rs` 模块处理翻译逻辑
- 新增 `locales/` 目录存放翻译文件
  - `locales/en/` - 英文翻译(默认)
  - `locales/zh-CN/` - 简体中文翻译
- 修改 [`src/args.rs`](src/args.rs) 添加 `--lang` 参数
- 修改各模块输出使用翻译宏/函数

### 配置方式
```bash
# 使用中文
genact --lang zh-CN

# 或通过环境变量
export GENACT_LANG=zh-CN
genact

# 自动检测(根据系统 LANG 环境变量)
genact
```

## Impact

### Affected Specs
- **NEW**: `i18n` - 国际化能力规范(新增)

### Affected Code
- [`src/args.rs`](src/args.rs:27) - 添加语言参数
- [`src/lib.rs`](src/lib.rs:49) - 修改退出消息
- [`src/main.rs`](src/main.rs:38) - 修改 "Available modules:" 提示
- `src/i18n.rs` - 新增 i18n 模块
- [`src/modules/*.rs`](src/modules/mod.rs:1) - 可选:模块输出中文化
- `Cargo.toml` - 添加 i18n 依赖

### Breaking Changes
**无破坏性变更** - 此功能为增强功能:
- 默认行为保持英文(向后兼容)
- 新增可选的 `--lang` 参数
- 不影响现有用户的使用方式

### 非破坏性影响
- **二进制大小**: 增加约 10-50KB(取决于翻译内容量)
- **性能**: 可忽略(翻译在启动时加载,运行时查表)
- **维护成本**: 需要维护翻译文件,但结构清晰
- **Web 版本**: WASM 大小会略微增加

### 依赖影响
- 新增 1-2 个 i18n 相关 crate(如 `rust-i18n` 或 `fluent`)
- 所有依赖均为纯 Rust,支持 WASM 编译

## Technical Approach

### 方案对比

本提案分析了三种主流 i18n 方案:

#### 方案 A: rust-i18n (推荐)
- **库**: `rust-i18n` crate
- **特点**:
  - 宏驱动,编译时生成代码
  - 支持 YAML 翻译文件,易于维护
  - 零运行时开销(翻译嵌入二进制)
  - 支持回退语言和插值
- **优势**:
  - 轻量级,仅约 20KB 额外大小
  - 编译时检查,减少运行时错误
  - WASM 友好,无特殊依赖
  - 易于集成到现有代码
- **劣势**:
  - 需要重新编译才能更新翻译
  - 不支持运行时动态加载翻译
- **适用性**: ⭐⭐⭐⭐⭐ 最适合 genact(静态编译工具)

#### 方案 B: fluent
- **库**: `fluent-rs` + `fluent-bundle`
- **特点**:
  - Mozilla Fluent 标准
  - 强大的复数和格式化规则
  - 运行时加载 FTL 翻译文件
  - 业界标准,支持复杂语法
- **优势**:
  - 功能强大,支持复杂语法(复数、性别等)
  - 生态系统成熟,工具链完善
  - 可运行时热加载翻译
- **劣势**:
  - 较重,增加约 50-100KB 二进制大小
  - 运行时解析,有一定性能开销
  - 对于简单场景过于复杂
- **适用性**: ⭐⭐⭐ 功能过剩,不适合简单场景

#### 方案 C: 手动实现
- **特点**:
  - 自己实现 `HashMap<&str, &str>` 翻译表
  - 无第三方依赖
  - 完全控制实现细节
- **优势**:
  - 零依赖,最小二进制大小
  - 实现简单,易于理解
  - 完全可控
- **劣势**:
  - 需要手动维护代码
  - 缺少工具支持(提取、验证等)
  - 难以扩展到多语言
  - 缺少插值、复数等高级特性
- **适用性**: ⭐⭐ 维护成本高,不推荐

### 推荐方案: rust-i18n

基于以下理由,推荐使用 `rust-i18n`:

1. **最佳性能**: 编译时生成,零运行时开销
2. **WASM 友好**: 无需文件系统,翻译嵌入二进制
3. **维护性**: YAML 文件易读易写,支持嵌套结构
4. **二进制大小**: 影响最小(~20KB)
5. **简单够用**: 满足 genact 的所有需求,不过度工程化

### 实现架构

```
┌─────────────────────────────────────────────────┐
│                   genact CLI                    │
└─────────────────────────────────────────────────┘
                       │
                       ├─ 1. 解析 --lang 参数
                       │  或检测环境变量
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│              i18n::init(lang)                   │
│  ┌─────────────────────────────────────────┐   │
│  │  设置全局语言(rust_i18n::set_locale)   │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│            使用 t! 宏获取翻译                   │
│  ┌─────────────────────────────────────────┐   │
│  │  t!("cli.help.description")             │   │
│  │  t!("module.downloading")               │   │
│  │  t!("exit.saving_work")                 │   │
│  └─────────────────────────────────────────┘   │
└─────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│          locales/ 翻译文件                      │
│  ┌─────────────────┬─────────────────────────┐ │
│  │ en/main.yml     │ zh-CN/main.yml          │ │
│  │ en/modules.yml  │ zh-CN/modules.yml       │ │
│  │ en/cli.yml      │ zh-CN/cli.yml           │ │
│  └─────────────────┴─────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

### 翻译文件结构

```yaml
# locales/zh-CN/cli.yml
cli:
  description: 一个无意义活动生成器
  help:
    list_modules: 列出可用的模块
    modules: 仅运行这些模块
    speed_factor: 全局速度因子
    exit_after_time: 运行指定时间后退出
    exit_after_modules: 运行指定次数后退出
  messages:
    available_modules: "可用模块:"
    saving_work: "正在将工作保存到磁盘..."

# locales/zh-CN/modules.yml
modules:
  common:
    downloading: 正在下载
    compiling: 正在编译
    finished: 完成
```

### 语言检测逻辑

```rust
// src/i18n.rs
pub fn detect_language() -> &'static str {
    // 1. 命令行参数优先
    if let Some(lang) = args.lang {
        return lang;
    }
    
    // 2. GENACT_LANG 环境变量
    if let Ok(lang) = std::env::var("GENACT_LANG") {
        return Box::leak(lang.into_boxed_str());
    }
    
    // 3. 系统 LANG 环境变量
    if let Ok(lang) = std::env::var("LANG") {
        if lang.starts_with("zh") {
            return "zh-CN";
        }
    }
    
    // 4. 默认英文
    "en"
}
```

## Alternatives Considered

### 替代方案 1: 仅提供 README 翻译
- **说明**: 不修改代码,仅提供中文 README 和文档
- **优势**: 零开发成本,零二进制大小影响
- **劣势**: 用户体验提升有限,CLI 使用时仍需理解英文
- **结论**: ❌ 不采纳,用户体验提升不足

### 替代方案 2: 完全重写中文版
- **说明**: 创建独立的中文分支或仓库
- **优势**: 可以完全本地化,包括数据文件
- **劣势**: 维护成本极高,代码重复,不符合开源最佳实践
- **结论**: ❌ 不采纳,维护成本不可接受

### 替代方案 3: 运行时从文件加载翻译
- **说明**: 使用 JSON/YAML 文件,运行时读取
- **优势**: 可以不重新编译更新翻译
- **劣势**: 
  - WASM 版本需要额外处理(embed 或网络请求)
  - 增加运行时依赖和启动时间
  - 文件路径管理复杂
- **结论**: ❌ 不采纳,与项目零依赖部署理念不符

## Migration Plan

本功能为增强性质,无需迁移:

### 对现有用户
- 默认行为不变(英文界面)
- 无需任何操作即可继续使用

### 对新用户
- 中文用户可以通过 `--lang zh-CN` 获得本地化体验
- 文档中添加语言切换说明

### 对开发者
- 新增代码使用 `t!()` 宏包裹用户可见字符串
- 添加翻译时更新 `locales/` 目录下对应语言文件
- CI 流程无需改动(编译时自动嵌入翻译)

## Risks and Mitigation

### 风险 1: 翻译质量不一致
- **影响**: 机器翻译或不准确的翻译影响用户体验
- **缓解**: 
  - 初始翻译由母语者审校
  - 在 CONTRIBUTING.md 中添加翻译指南
  - 接受社区贡献改进翻译

### 风险 2: 维护负担增加
- **影响**: 每次添加新消息需要同步翻译
- **缓解**:
  - 使用清晰的翻译 key 命名规范
  - CI 检查缺失翻译(rust-i18n 编译时警告)
  - 回退机制:缺失翻译显示英文

### 风险 3: 二进制大小膨胀
- **影响**: 嵌入翻译增加可执行文件大小
- **缓解**:
  - 使用 rust-i18n(最小化大小影响)
  - 仅翻译必要内容(不翻译技术术语)
  - 监控发布版本大小

### 风险 4: WASM 兼容性
- **影响**: i18n 库可能不支持 WASM
- **缓解**:
  - 选择明确支持 WASM 的库(rust-i18n 已验证)
  - 在 CI 中添加 WASM 编译测试
  - 必要时使用 `cfg` 为 WASM 提供简化实现

## Implementation Phases

### Phase 1: 基础设施 (核心功能)
**目标**: 建立 i18n 基础,支持 CLI 帮助信息中文化

- [x] 选择并集成 rust-i18n crate
- [ ] 创建翻译文件结构 (`locales/en/`, `locales/zh-CN/`)
- [ ] 实现语言检测和初始化逻辑
- [ ] 添加 `--lang` 命令行参数
- [ ] 翻译 CLI 帮助信息和错误消息
- [ ] 更新文档说明语言切换功能

**交付物**: 用户可以使用 `genact --lang zh-CN --help` 看到中文帮助

### Phase 2: 模块输出中文化 (可选增强)
**目标**: 中文化模块运行时输出

- [ ] 提取所有模块中的通用状态词
- [ ] 创建 `locales/{lang}/modules.yml`
- [ ] 修改模块输出使用翻译宏
- [ ] 测试所有 19 个模块的中文输出
- [ ] 确保技术术语保持英文(包名、命令等)

**交付物**: `genact --lang zh-CN -m cargo` 显示中文状态消息

### Phase 3: Web 版本支持 (可选增强)
**目标**: Web 版本支持语言切换

- [ ] 实现 Web 环境语言检测(浏览器语言)
- [ ] 添加 URL 参数支持 (`?lang=zh-CN`)
- [ ] 适配 WASM 编译配置
- [ ] 更新 Web 页面说明语言参数

**交付物**: https://svenstaro.github.io/genact?lang=zh-CN 显示中文

## Success Metrics

- ✅ 编译通过(原生 + WASM)
- ✅ 所有现有测试通过
- ✅ `genact --lang zh-CN --help` 显示中文帮助
- ✅ `genact --lang en` 或无参数显示英文(默认)
- ✅ 二进制大小增加 < 50KB
- ✅ 中文翻译覆盖率 > 90%
- ✅ 至少 1 名中文母语者审校翻译质量
- ✅ 文档更新包含语言切换说明

## Open Questions

1. **模块输出是否需要中文化?**
   - 问题: 模拟场景输出(如 "Compiling package v1.0")是否翻译?
   - 影响: 翻译范围、工作量、真实度
   - 建议: 先实现 Phase 1,根据用户反馈决定 Phase 2

2. **是否支持更多语言?**
   - 问题: 是否在同一 PR 中添加其他语言(如日文、韩文)?
   - 影响: 开发工作量、维护负担
   - 建议: 先支持简体中文,框架设计支持扩展

3. **Web 版本优先级?**
   - 问题: Web 版本是否与 CLI 同步支持中文?
   - 影响: 开发周期、测试复杂度
   - 建议: Phase 3 独立评估,可延后

4. **繁体中文支持?**
   - 问题: 是否同时支持 zh-TW(繁体中文)?
   - 影响: 翻译工作量
   - 建议: 先支持 zh-CN,后续社区贡献 zh-TW

## References

- [rust-i18n GitHub](https://github.com/longbridgeapp/rust-i18n)
- [Mozilla Fluent](https://projectfluent.org/)
- [Rust i18n 生态对比](https://lib.rs/keywords/i18n)
- [WASM 国际化最佳实践](https://rustwasm.github.io/docs/book/)
